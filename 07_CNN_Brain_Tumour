# Install TensorFlow if not installed
# !pip install tensorflow --quiet

import tensorflow as tf
from tensorflow.keras.preprocessing.image import ImageDataGenerator
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Conv2D, MaxPooling2D, Flatten, Dense, Dropout
import matplotlib.pyplot as plt
import numpy as np
import os
import random

# Step 1: Define dataset paths
train_dir = r"C:\Users\ASHUTOSH\Downloads\DL-Datasets\brain tumour\Training"
test_dir = r"C:\Users\ASHUTOSH\Downloads\DL-Datasets\brain tumour\Testing"

# Step 2: Data preprocessing
train_datagen = ImageDataGenerator(rescale=1./255)
test_datagen = ImageDataGenerator(rescale=1./255)

train_generator = train_datagen.flow_from_directory(
    train_dir,
    target_size=(150, 150),
    batch_size=32,
    class_mode='categorical'  # Multi-class classification
)

test_generator = test_datagen.flow_from_directory(
    test_dir,
    target_size=(150, 150),
    batch_size=32,
    class_mode='categorical'
)

# Step 3: Build CNN model
model = Sequential([
    Conv2D(32, (3,3), activation='relu', input_shape=(150,150,3)),
    MaxPooling2D(2,2),
    
    Conv2D(64, (3,3), activation='relu'),
    MaxPooling2D(2,2),
    
    Conv2D(128, (3,3), activation='relu'),
    MaxPooling2D(2,2),
    
    Flatten(),
    Dense(256, activation='relu'),
    Dropout(0.5),
    Dense(4, activation='softmax')  # 4 output classes
])

# Step 4: Compile the model
model.compile(
    optimizer='adam',
    loss='categorical_crossentropy',
    metrics=['accuracy']
)

# Step 5: Train the model
history = model.fit(
    train_generator,
    epochs=10,
    validation_data=test_generator
)
test_loss, test_acc = model.evaluate(test_generator)
print(f"\nâœ… Test Accuracy: {test_acc*100:.2f}%")

# Step 7: Plot accuracy and loss
plt.figure(figsize=(12,5))

plt.subplot(1,2,1)
plt.plot(history.history['accuracy'], label='Train Accuracy')
plt.plot(history.history['val_accuracy'], label='Validation Accuracy')
plt.title('Model Accuracy')
plt.xlabel('Epochs')
plt.ylabel('Accuracy')
plt.legend()

plt.subplot(1,2,2)
plt.plot(history.history['loss'], label='Train Loss')
plt.plot(history.history['val_loss'], label='Validation Loss')
plt.title('Model Loss')
plt.xlabel('Epochs')
plt.ylabel('Loss')
plt.legend()

plt.show()

# Step 8: Define class labels
class_labels = list(train_generator.class_indices.keys())
print("Class labels:", class_labels)

# Step 9: Show 5 test images with predicted & actual labels
x_test_batch, y_test_batch = next(test_generator)

plt.figure(figsize=(15,4))
for i in range(5):
    img = x_test_batch[i]
    true_label = class_labels[np.argmax(y_test_batch[i])]
    
    pred = model.predict(img[np.newaxis, ...])
    predicted_label = class_labels[np.argmax(pred)]

    plt.subplot(1,5,i+1)
    plt.imshow(img)
    plt.title(f"Pred: {predicted_label}\nActual: {true_label}")
    plt.axis("off")

plt.show()






#class_labels = list(train_generator.class_indices.keys())
# print("Classes:", class_labels)

# # Pick a random image from the test set
# random_class = random.choice(os.listdir(test_dir))
# random_path = os.path.join(test_dir, random_class)
# random_img = random.choice(os.listdir(random_path))
# img_path = os.path.join(random_path, random_img)

# # Load and display image
# img = tf.keras.utils.load_img(img_path, target_size=(150,150))
# plt.imshow(img)
# plt.axis('off')

# # Predict
# img_array = tf.keras.utils.img_to_array(img) / 255.0
# img_array = np.expand_dims(img_array, axis=0)

# pred = model.predict(img_array)
# predicted_label = class_labels[np.argmax(pred)]
# plt.title(f"Predicted: {predicted_label}")
# plt.show()
